<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Nexus | Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #f1f5f9; 
            color: #334155; 
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .card-pro {
            background: #ffffff;
            border-radius: 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .card-pro:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .accent-bar {
            position: absolute; top: 0; left: 0; right: 0; height: 4px;
        }

        .bg-today { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .bg-yesterday { background: linear-gradient(90deg, #a855f7, #7c3aed); }
        .bg-db-yesterday { background: linear-gradient(90deg, #64748b, #334155); }
        .bg-week { background: linear-gradient(90deg, #06b6d4, #0891b2); }
        .bg-month { background: linear-gradient(90deg, #ec4899, #be185d); }
        .bg-net { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .bg-avg { background: linear-gradient(90deg, #10b981, #059669); }

        #leadPopup {
            position: fixed; bottom: 30px; right: 30px;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2000;
        }
        #leadPopup.show { transform: translateX(0); }

        .progress-bar {
            background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            background: #3b82f6; height: 100%; transition: width 1s ease-in-out;
        }

        #overlay {
            position: fixed; inset: 0; background: #0f172a;
            z-index: 3000; display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <div id="overlay">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-white mb-8 tracking-tight">CPA <span class="text-blue-500">GRIP</span></h1>
            <button onclick="initializeSystem()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3 rounded-xl font-bold transition-all">SIGN IN</button>
        </div>
    </div>

    <div id="leadPopup" class="bg-white border-l-4 border-green-500 shadow-2xl rounded-xl p-5 flex items-center gap-4 min-w-[300px]">
        <div class="bg-green-100 p-2 rounded-lg text-green-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <div>
            <p class="text-[10px] font-bold text-slate-400 uppercase">New Yield Detected</p>
            <p id="popupAmount" class="text-lg font-bold text-slate-800">+$0.00 Added</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">N</div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">CPAGRIP Postback Dashboard</h1>
                    <p class="text-xs text-slate-400 font-medium tracking-wide">Command Interface v2.0</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-6">
                <div class="text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">System Time</p>
                    <p id="liveClock" class="text-lg font-bold text-slate-700">00:00:00 AM</p>
                </div>
                <div class="w-10 h-10 bg-slate-100 rounded-full border border-slate-200 flex items-center justify-center font-bold text-slate-500">AD</div>
            </div>
        </header>

        <div class="card-pro p-8 mb-8">
            <div class="accent-bar bg-today"></div>
            <div class="flex flex-col md:flex-row justify-between items-end gap-6">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Today's Revenue (Reset 1:30 PM)</p>
                    <h2 id="dailyRev" class="text-6xl font-black text-slate-900">$0.00</h2>
                </div>
                <div class="w-full md:w-64">
                    <div class="flex justify-between mb-2">
                        <span id="percentNum" class="text-sm font-bold text-blue-600">0%</span>
                        <span class="text-xs font-bold text-slate-400">Target $100</span>
                    </div>
                    <div class="progress-bar"><div id="goalBar" class="progress-fill" style="width: 0%"></div></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
            <div class="card-pro p-6">
                <div class="accent-bar bg-yesterday"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Yesterday</p>
                <p id="yesterdayRev" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card-pro p-6">
                <div class="accent-bar bg-db-yesterday"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Before Yesterday</p>
                <p id="dbYesterdayRev" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card-pro p-6">
                <div class="accent-bar bg-week"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Last 7 Days</p>
                <p id="weekRev" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card-pro p-6">
                <div class="accent-bar bg-month"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">This Month</p>
                <p id="monthRev" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card-pro p-6">
                <div class="accent-bar bg-net"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Total Net</p>
                <p id="totalNet" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card-pro p-6">
                <div class="accent-bar bg-avg"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Avg Payout</p>
                <p id="avgPay" class="text-3xl font-bold text-slate-800">$0.00</p>
            </div>
        </div>

        <div class="card-pro overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Live Transaction Stream</h3>
                <span id="topCountry" class="text-[10px] font-bold bg-blue-100 text-blue-600 px-4 py-1.5 rounded-lg uppercase tracking-wider">Loading...</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto max-h-[400px]">
                <table class="w-full text-left">
                    <thead class="bg-white sticky top-0 border-b border-slate-100">
                        <tr class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">
                            <th class="px-8 py-4">Time</th>
                            <th class="px-8 py-4">Agent ID</th>
                            <th class="px-8 py-4">Operation</th>
                            <th class="px-8 py-4 text-right">Yield</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTable" class="divide-y divide-slate-100 text-sm font-medium">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- LOCAL SOUND CONFIG ---
        // GitHub එකට upload කරපු sound file එකේ නම මෙතනට දාන්න (e.g., 'alert.mp3')
        const customSoundUrl = 'sound.mp3'; 
        const notificationSound = new Audio(customSoundUrl);

        const appUrl = 'https://script.google.com/macros/s/AKfycbzkiT8xK9umDamSUgi0mjMMHMj21FXRQVS80uousnrK93ioAxOKWvxR44ClUqHT7kAvXw/exec';
        const dailyGoal = 100;
        let lastLeadCount = 0;
        let isInitialized = false;

        function initializeSystem() {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
            isInitialized = true;
            
            // Browser එකෙන් sound block කරන එක නැති කරන්න පොඩි trick එකක්
            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
            }).catch(e => console.log("Audio waiting for interaction"));
            
            refreshData();
        }

        function updateClock() {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('en-US', { hour12: true });
        }
        setInterval(updateClock, 1000);

        function showNotification(amount) {
            const popup = document.getElementById('leadPopup');
            document.getElementById('popupAmount').innerText = `+$${amount.toFixed(2)} Added`;
            popup.classList.add('show');
            
            // Sound play කිරීම
            notificationSound.currentTime = 0;
            notificationSound.play().catch(e => console.error("Sound play error:", e));
            
            setTimeout(() => popup.classList.remove('show'), 3000);
        }

        function getNexusDate(dateObj) {
            const d = new Date(dateObj);
            const hours = d.getHours();
            if (hours < 13 || (hours === 13 && d.getMinutes() < 30)) d.setDate(d.getDate() - 1);
            return d.toDateString();
        }

        async function refreshData() {
            if(!isInitialized) return;
            try {
                const response = await fetch(appUrl);
                const data = await response.json();
                const sorted = data.reverse();

                if (sorted.length > lastLeadCount && lastLeadCount !== 0) {
                    showNotification(parseFloat(sorted[0].Payout) || 0);
                }

                let total = 0, daily = 0, yesterday = 0, dbYesterday = 0, week = 0, month = 0;
                let countries = {}, tableHtml = '';

                const now = new Date();
                const nexusToday = getNexusDate(now);
                const yestObj = new Date(); yestObj.setDate(yestObj.getDate() - 1);
                const nexusYesterday = getNexusDate(yestObj);
                const dbYestObj = new Date(); dbYestObj.setDate(dbYestObj.getDate() - 2);
                const nexusDbYesterday = getNexusDate(dbYestObj);
                const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                sorted.forEach((row) => {
                    const pay = parseFloat(row.Payout) || 0;
                    const lDate = new Date(row.Date);
                    const lNexusDate = getNexusDate(lDate);
                    
                    total += pay;
                    if(lNexusDate === nexusToday) daily += pay;
                    if(lNexusDate === nexusYesterday) yesterday += pay;
                    if(lNexusDate === nexusDbYesterday) dbYesterday += pay;
                    if(lDate >= sevenDaysAgo) week += pay;
                    if(lDate.getMonth() === now.getMonth() && lDate.getFullYear() === now.getFullYear()) month += pay;
                    
                    if(row.Country) countries[row.Country] = (countries[row.Country] || 0) + 1;

                    tableHtml += `<tr class="hover:bg-slate-50 transition-all">
                        <td class="px-8 py-5 text-slate-400 font-medium text-xs">${lDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                        <td class="px-8 py-5"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded font-bold text-xs">#${row.ID}</span></td>
                        <td class="px-8 py-5 text-slate-600 font-medium">${row.Offer}</td>
                        <td class="px-8 py-5 text-right font-bold text-slate-900">+$${pay.toFixed(2)}</td>
                    </tr>`;
                });

                document.getElementById('dailyRev').innerText = '$' + daily.toFixed(2);
                document.getElementById('yesterdayRev').innerText = '$' + yesterday.toFixed(2);
                document.getElementById('dbYesterdayRev').innerText = '$' + dbYesterday.toFixed(2);
                document.getElementById('weekRev').innerText = '$' + week.toFixed(2);
                document.getElementById('monthRev').innerText = '$' + month.toFixed(2);
                document.getElementById('totalNet').innerText = '$' + total.toFixed(2);
                document.getElementById('avgPay').innerText = '$' + (sorted.length > 0 ? total/sorted.length : 0).toFixed(2);
                document.getElementById('leadsTable').innerHTML = tableHtml;
                
                let p = (daily / dailyGoal) * 100;
                document.getElementById('goalBar').style.width = Math.min(p, 100) + '%';
                document.getElementById('percentNum').innerText = Math.round(p) + '%';
                
                let topC = Object.keys(countries).reduce((a, b) => countries[a] > countries[b] ? a : b, '---');
                document.getElementById('topCountry').innerText = 'TOP: ' + topC;
                lastLeadCount = sorted.length;
            } catch (e) { console.error("Sync Error"); }
        }

        setInterval(refreshData, 10000);
        updateClock();
    </script>
</body>
</html>
